# æ—¥å¿—æ¸…ç†æŒ‡å—

## ðŸš¨ é—®é¢˜æè¿°

ç³»ç»Ÿä¸­å­˜åœ¨å¤§é‡å­¤å„¿æ—¥å¿—æ–‡ä»¶ï¼ˆæ²¡æœ‰å¯¹åº”æ•°æ®åº“è®°å½•çš„åŽ†å²æ—¥å¿—ï¼‰ï¼Œå¯¼è‡´ç£ç›˜ç©ºé—´æµªè´¹ã€‚

### ðŸ” é—®é¢˜è¡¨çŽ°
- æ—¥å¿—ç›®å½•ä¸‹æœ‰å¾ˆå¤šåŽ†å²æ—¥å¿—æ–‡ä»¶
- åˆ é™¤åŽ†å²ä»»åŠ¡æ—¶ï¼Œåªåˆ é™¤ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå…¶ä»–ç›¸å…³æ—¥å¿—æ–‡ä»¶ä»ç„¶å­˜åœ¨
- ç£ç›˜ç©ºé—´è¢«å¤§é‡æ— ç”¨æ—¥å¿—æ–‡ä»¶å ç”¨

## ðŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### 1. ç«‹å³æ¸…ç†å­¤å„¿æ—¥å¿—æ–‡ä»¶

#### ðŸ“‹ é¢„è§ˆæ¸…ç†æ“ä½œï¼ˆæŽ¨èå…ˆæ‰§è¡Œï¼‰
```bash
cd /path/to/WorldQuant
python3 scripts/cleanup_orphan_logs.py --dry-run
```

#### ðŸ—‘ï¸ æ‰§è¡Œå®žé™…æ¸…ç†
```bash
cd /path/to/WorldQuant
python3 scripts/cleanup_orphan_logs.py --execute
```

#### â° åªæ¸…ç†è¶…è¿‡æŒ‡å®šå¤©æ•°çš„æ–‡ä»¶
```bash
# åªæ¸…ç†è¶…è¿‡7å¤©çš„å­¤å„¿æ—¥å¿—
python3 scripts/cleanup_orphan_logs.py --execute --days 7

# åªæ¸…ç†è¶…è¿‡3å¤©çš„å­¤å„¿æ—¥å¿—
python3 scripts/cleanup_orphan_logs.py --execute --days 3
```

### 2. æ¸…ç†è„šæœ¬åŠŸèƒ½è¯´æ˜Ž

#### ðŸ” è‡ªåŠ¨è¯†åˆ«åŠŸèƒ½
- **å­¤å„¿æ—¥å¿—æ£€æµ‹**ï¼šè‡ªåŠ¨è¯†åˆ«æ²¡æœ‰æ•°æ®åº“è®°å½•çš„æ—¥å¿—æ–‡ä»¶
- **è„šæœ¬ç±»åž‹åˆ†æž**ï¼šæ”¯æŒ `check_optimized`ã€`correlation_checker`ã€`unified_digging` ç­‰
- **å¤§å°ç»Ÿè®¡**ï¼šæ˜¾ç¤ºæ¯ä¸ªç±»åž‹çš„æ–‡ä»¶æ•°é‡å’Œå ç”¨ç©ºé—´
- **å®‰å…¨é¢„è§ˆ**ï¼šé»˜è®¤é¢„è§ˆæ¨¡å¼ï¼Œé¿å…è¯¯åˆ 

#### ðŸ“Š æ¸…ç†æŠ¥å‘Šç¤ºä¾‹
```
ðŸ§¹ å­¤å„¿æ—¥å¿—æ–‡ä»¶æ¸…ç†å·¥å…·
==================================================
ðŸ“‚ æ‰«ææ—¥å¿—ç›®å½•: /path/to/logs
ðŸ“Š å‘çŽ° 43 ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œæ€»å¤§å°: 487.23 MB
  ðŸ“„ check_optimized: 15 ä¸ªæ–‡ä»¶ï¼Œ234.56 MB
  ðŸ“„ correlation_checker: 18 ä¸ªæ–‡ä»¶ï¼Œ198.34 MB  
  ðŸ“„ unified_digging: 10 ä¸ªæ–‡ä»¶ï¼Œ54.33 MB

ðŸ“‹ æ•°æ®åº“ä¸­æœ‰ 4 ä¸ªæ—¥å¿—æ–‡ä»¶è®°å½•

ðŸ“Š æ¸…ç†æŠ¥å‘Š
==================================================
ðŸ” å‘çŽ° 39 ä¸ªå­¤å„¿æ—¥å¿—æ–‡ä»¶ï¼Œæ€»å¤§å°: 456.78 MB
  ðŸ“„ check_optimized: 13 ä¸ªæ–‡ä»¶ï¼Œ212.34 MB
  ðŸ“„ correlation_checker: 16 ä¸ªæ–‡ä»¶ï¼Œ178.12 MB
  ðŸ“„ unified_digging: 10 ä¸ªæ–‡ä»¶ï¼Œ66.32 MB

âœ… æ¸…ç†å®Œæˆ:
  ðŸ—‘ï¸ å·²åˆ é™¤: 39 ä¸ªæ–‡ä»¶
  ðŸ’¾ é‡Šæ”¾ç©ºé—´: 456.78 MB
```

### 3. æ”¹è¿›çš„æ—¥å¿—åˆ é™¤é€»è¾‘

#### ðŸ”§ æ–°çš„åˆ é™¤ä»»åŠ¡æ—¶æ¸…ç†é€»è¾‘
çŽ°åœ¨åˆ é™¤ä»»åŠ¡æ—¶ä¼šæ™ºèƒ½æ¸…ç†ç›¸å…³æ—¥å¿—ï¼š

1. **è½®è½¬æ—¥å¿—æ–‡ä»¶**ï¼š`filename.log.1`, `filename.log.2` ç­‰
2. **åŒPIDå…³è”æ—¥å¿—**ï¼šåŒä¸€è¿›ç¨‹äº§ç”Ÿçš„å…¶ä»–æ—¥å¿—æ–‡ä»¶
3. **å®‰å…¨ä¿æŠ¤**ï¼šä¸ä¼šè¯¯åˆ æ­£åœ¨è¿è¡Œä»»åŠ¡çš„æ—¥å¿—

#### ðŸ“ æ—¥å¿—æ–‡ä»¶å‘½åè§„èŒƒ
```
æ ¼å¼: {script_type}_{YYYYMMDD}_{HHMMSS}_{pid}.log

ç¤ºä¾‹:
- check_optimized_20250904_015221_186.log
- correlation_checker_20250904_020020_296.log  
- unified_digging_20250904_073040_1822.log
```

## ðŸ”„ å®šæœŸç»´æŠ¤å»ºè®®

### ðŸ“… å»ºè®®æ¸…ç†é¢‘çŽ‡
- **æ¯å‘¨æ¸…ç†**ï¼šæ¸…ç†è¶…è¿‡7å¤©çš„å­¤å„¿æ—¥å¿—
- **æ¯æœˆæ¸…ç†**ï¼šå®Œæ•´æ‰«æå’Œæ¸…ç†æ‰€æœ‰å­¤å„¿æ—¥å¿—
- **ç´§æ€¥æ¸…ç†**ï¼šç£ç›˜ç©ºé—´ä¸è¶³æ—¶ç«‹å³æ¸…ç†

### ðŸ¤– è‡ªåŠ¨åŒ–æ¸…ç†ï¼ˆå¯é€‰ï¼‰
æ·»åŠ åˆ° crontab ä¸­è¿›è¡Œå®šæœŸè‡ªåŠ¨æ¸…ç†ï¼š

```bash
# ç¼–è¾‘ crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹æ¸…ç†è¶…è¿‡7å¤©çš„å­¤å„¿æ—¥å¿—ï¼‰
0 2 * * 0 cd /path/to/WorldQuant && python3 scripts/cleanup_orphan_logs.py --execute --days 7 >> /var/log/log_cleanup.log 2>&1
```

### ðŸ“Š ç›‘æŽ§ç£ç›˜ä½¿ç”¨
```bash
# æ£€æŸ¥logsç›®å½•å¤§å°
du -sh /path/to/WorldQuant/logs

# æ£€æŸ¥ç³»ç»Ÿç£ç›˜ä½¿ç”¨
df -h

# æŒç»­ç›‘æŽ§ï¼ˆå¯é€‰ï¼‰
watch -n 300 'du -sh /path/to/WorldQuant/logs'
```

## ðŸš¨ ç´§æ€¥æƒ…å†µå¤„ç†

### ðŸ’¾ ç£ç›˜ç©ºé—´ä¸è¶³
```bash
# 1. ç«‹å³æ£€æŸ¥æ—¥å¿—ç›®å½•å¤§å°
du -sh /path/to/WorldQuant/logs

# 2. ç´§æ€¥æ¸…ç†æ‰€æœ‰å­¤å„¿æ—¥å¿—
python3 scripts/cleanup_orphan_logs.py --execute

# 3. å¦‚æžœä»ä¸è¶³ï¼Œæ¸…ç†è¶…è¿‡1å¤©çš„æ–‡ä»¶
python3 scripts/cleanup_orphan_logs.py --execute --days 1

# 4. æ£€æŸ¥ç³»ç»Ÿå…¶ä»–å¤§æ–‡ä»¶
find /path/to/WorldQuant -size +100M -type f
```

### ðŸ”§ è„šæœ¬æ‰§è¡Œé—®é¢˜
```bash
# æ£€æŸ¥PythonçŽ¯å¢ƒ
python3 --version

# æ£€æŸ¥ä¾èµ–
python3 -c "import sqlalchemy; print('SQLAlchemy OK')"

# æ£€æŸ¥æ•°æ®åº“è¿žæŽ¥
python3 -c "
import sys, os
sys.path.append('/path/to/WorldQuant/digging-dashboard/backend')
from app.db.models import DiggingProcess
print('Database models OK')
"

# æ£€æŸ¥æƒé™
ls -la scripts/cleanup_orphan_logs.py
```

## ðŸ“ ä½¿ç”¨æ³¨æ„äº‹é¡¹

### âš ï¸ å®‰å…¨æé†’
1. **å…ˆé¢„è§ˆå†æ‰§è¡Œ**ï¼šå»ºè®®æ€»æ˜¯å…ˆä½¿ç”¨ `--dry-run` é¢„è§ˆ
2. **å¤‡ä»½é‡è¦æ—¥å¿—**ï¼šå¦‚æœ‰éœ€è¦ï¼Œå…ˆå¤‡ä»½é‡è¦çš„æ—¥å¿—æ–‡ä»¶
3. **é¿å…åˆ é™¤æ´»åŠ¨ä»»åŠ¡æ—¥å¿—**ï¼šè„šæœ¬ä¼šè‡ªåŠ¨ä¿æŠ¤æ•°æ®åº“ä¸­æœ‰è®°å½•çš„æ—¥å¿—

### ðŸŽ¯ æœ€ä½³å®žè·µ
1. **å®šæœŸæ¸…ç†**ï¼šå»ºç«‹å®šæœŸæ¸…ç†æœºåˆ¶ï¼Œé¿å…ç§¯ç´¯è¿‡å¤š
2. **ç›‘æŽ§ç©ºé—´**ï¼šå®šæœŸæ£€æŸ¥ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ
3. **é€‚å½“ä¿ç•™**ï¼šå¯ä»¥ä½¿ç”¨ `--days` å‚æ•°ä¿ç•™æœ€è¿‘å‡ å¤©çš„æ—¥å¿—
4. **æ—¥å¿—è½®è½¬**ï¼šç¡®ä¿Dockerå®¹å™¨çš„æ—¥å¿—è½®è½¬æ­£å¸¸å·¥ä½œ

## ðŸ†˜ æ”¯æŒä¸Žæ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜
1. **æƒé™é”™è¯¯**ï¼šç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™å’Œæ—¥å¿—ç›®å½•çš„å†™æƒé™
2. **æ•°æ®åº“è¿žæŽ¥å¤±è´¥**ï¼šæ£€æŸ¥æ•°æ®åº“æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
3. **Pythonä¾èµ–ç¼ºå¤±**ï¼šç¡®ä¿å®‰è£…äº†å¿…è¦çš„PythonåŒ…

### èŽ·å–å¸®åŠ©
```bash
# æŸ¥çœ‹è„šæœ¬å¸®åŠ©
python3 scripts/cleanup_orphan_logs.py --help

# æŸ¥çœ‹è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹
python3 scripts/cleanup_orphan_logs.py --execute --days 7 2>&1 | tee cleanup.log
```
