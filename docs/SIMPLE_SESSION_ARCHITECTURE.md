# ç®€åŒ–ä¼šè¯ç®¡ç†æ¶æ„

## ğŸ¯ è®¾è®¡ç†å¿µ

é‡‡ç”¨**èŒè´£åˆ†ç¦»**çš„ç®€å•æ¶æ„ï¼Œå½»åº•è§£å†³å¤šè¿›ç¨‹ä¼šè¯å†²çªé—®é¢˜ï¼š

- **SessionKeeper**: ç‹¬ç«‹æœåŠ¡ï¼Œä¸“é—¨è´Ÿè´£ç™»å½•è®¤è¯å’Œcookieç»´æŠ¤
- **SessionClient**: è½»é‡çº§å®¢æˆ·ç«¯ï¼Œå…¶ä»–è„šæœ¬ç”¨å®ƒè·å–cookies
- **æ•°æ®åº“**: ç»Ÿä¸€çš„cookieå­˜å‚¨å’Œåˆ†å‘ä¸­å¿ƒ

## ğŸ—ï¸ æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç®€åŒ–ä¼šè¯ç®¡ç†æ¶æ„                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    å®šæœŸåˆ·æ–°     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SessionKeeper  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   WorldQuant     â”‚
â”‚   (ç‹¬ç«‹æœåŠ¡)     â”‚    ç™»å½•è®¤è¯      â”‚      API         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ ä¿å­˜cookies
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æ•°æ®åº“å­˜å‚¨     â”‚
â”‚ active_session_ â”‚
â”‚    cookies      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²
         â”‚ è¯»å–cookies
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ–æ˜è„šæœ¬1        â”‚    â”‚ æŒ–æ˜è„šæœ¬2        â”‚    â”‚ å…¶ä»–è„šæœ¬         â”‚
â”‚ SessionClient   â”‚    â”‚ SessionClient   â”‚    â”‚ SessionClient   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ ç»„ä»¶è¯¦è§£

### 1. SessionKeeper (src/session_keeper.py)
**èŒè´£**: ç‹¬ç«‹çš„è®¤è¯æœåŠ¡
- âœ… **æ™ºèƒ½å¯åŠ¨**: å¯åŠ¨æ—¶å…ˆæ£€æŸ¥æ•°æ®åº“ä¸­çš„ç°æœ‰ä¼šè¯ï¼Œé¿å…ä¸å¿…è¦çš„ç™»å½•
- âœ… **å®šæœŸæ£€æŸ¥**: æ¯15åˆ†é’Ÿæ£€æŸ¥ï¼Œæå‰30åˆ†é’Ÿåˆ·æ–°
- âœ… **Cookieå­˜å‚¨**: å°†æœ‰æ•ˆcookiesä¿å­˜åˆ°æ•°æ®åº“
- âœ… **çŠ¶æ€ç›‘æ§**: è®°å½•åˆ·æ–°æ¬¡æ•°ã€é”™è¯¯æ¬¡æ•°ç­‰
- âœ… **æ•…éšœæ¢å¤**: è‡ªåŠ¨é‡è¯•å’Œé”™è¯¯å¤„ç†

**ç‰¹ç‚¹**:
- ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–å…¶ä»–è„šæœ¬
- æ™ºèƒ½æ£€æŸ¥ç°æœ‰ä¼šè¯çŠ¶æ€ï¼Œå‡å°‘ä¸å¿…è¦çš„ç™»å½•è¯·æ±‚
- å®Œæ•´çš„æ—¥å¿—è®°å½•å’ŒçŠ¶æ€ç›‘æ§

### 2. SessionClient (src/session_client.py)
**èŒè´£**: è½»é‡çº§ä¼šè¯å®¢æˆ·ç«¯
- âœ… **Cookieè¯»å–**: ä»æ•°æ®åº“è¯»å–SessionKeeperç»´æŠ¤çš„cookies
- âœ… **ä¼šè¯åˆ›å»º**: åŸºäºcookiesåˆ›å»ºrequests.Sessionå¯¹è±¡
- âœ… **æœ‰æ•ˆæ€§æ£€æŸ¥**: éªŒè¯cookiesæ˜¯å¦è¿‡æœŸå’Œå¯ç”¨
- âœ… **ç®€å•æ¥å£**: æä¾›get_session()ç­‰ä¾¿æ·å‡½æ•°

**ç‰¹ç‚¹**:
- åªè¯»æ¨¡å¼ï¼Œä¸è´Ÿè´£è®¤è¯
- æœ€å°åŒ–ä¾èµ–å’Œå¤æ‚åº¦
- å‹å¥½çš„é”™è¯¯æç¤º

### 3. ç›´æ¥ä½¿ç”¨ (src/session_keeper.py)
**èŒè´£**: SessionKeeperæœ¬èº«å°±æä¾›å®Œæ•´çš„å‘½ä»¤è¡Œæ¥å£
- âœ… **å¯åŠ¨/åœæ­¢**: `python src/session_keeper.py --action start/stop`
- âœ… **çŠ¶æ€æ£€æŸ¥**: `python src/session_keeper.py --action status`
- âœ… **å¼ºåˆ¶åˆ·æ–°**: `python src/session_keeper.py --action refresh`

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨SessionKeeper
```bash
# å¯åŠ¨ä¼šè¯ä¿æŒæœåŠ¡
python src/session_keeper.py --action start

# åå°è¿è¡Œ
nohup python src/session_keeper.py --action start > session_keeper.log 2>&1 &
```

### 2. åœ¨å…¶ä»–è„šæœ¬ä¸­ä½¿ç”¨
```python
# ç®€å•ä½¿ç”¨
from session_client import get_session

session = get_session()
response = session.get('https://api.worldquantbrain.com/users/self')

# è·å–cookiesï¼ˆç”¨äºå¼‚æ­¥æ“ä½œï¼‰
from session_client import get_session_cookies

cookies = get_session_cookies()
```

### 3. ç®¡ç†å’Œç›‘æ§
```bash
# æ£€æŸ¥ä¼šè¯çŠ¶æ€
python src/session_keeper.py --action status

# å¼ºåˆ¶åˆ·æ–°ä¼šè¯
python src/session_keeper.py --action refresh

# åœæ­¢æœåŠ¡ï¼ˆé€šå¸¸é€šè¿‡Ctrl+Cæˆ–è¿›ç¨‹ç®¡ç†ï¼‰
```

## ğŸ”§ é…ç½®è¦æ±‚

### 1. ç”¨æˆ·å‡­æ®é…ç½®
ç¡®ä¿ `config/user_info.txt` å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®ï¼š
```
your_email@example.com
your_password
```

### 2. æ•°æ®åº“é…ç½®
ç¡®ä¿æ•°æ®åº“è¿æ¥æ­£å¸¸ï¼ŒSessionKeeperä¼šè‡ªåŠ¨åˆ›å»ºå¿…è¦çš„é…ç½®é¡¹ã€‚

## ğŸ¯ è§£å†³çš„é—®é¢˜

### âŒ åŸæœ‰é—®é¢˜
- å¤šä¸ªè¿›ç¨‹åŒæ—¶åˆ·æ–°ä¼šè¯
- ä¼šè¯çŠ¶æ€ä¸åŒæ­¥
- å¤æ‚çš„åè°ƒæœºåˆ¶
- éš¾ä»¥è°ƒè¯•å’Œç»´æŠ¤

### âœ… æ–°æ¶æ„ä¼˜åŠ¿
- **å•ç‚¹è®¤è¯**: åªæœ‰SessionKeeperè´Ÿè´£ç™»å½•
- **æ— å†²çª**: å…¶ä»–è„šæœ¬åªè¯»å–cookiesï¼Œä¸ä¼šå†²çª
- **ç®€å•å¯é **: æ¶æ„æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
- **æ˜“äºç›‘æ§**: é›†ä¸­çš„çŠ¶æ€ç®¡ç†å’Œæ—¥å¿—è®°å½•

## ğŸ“Š å¯¹æ¯”åˆ†æ

| ç‰¹æ€§ | åŸV1æ¶æ„ | åè°ƒå™¨V2æ¶æ„ | ç®€åŒ–æ¶æ„ |
|------|----------|-------------|----------|
| **å¤æ‚åº¦** | ä¸­ç­‰ | é«˜ | ä½ |
| **å†²çªé—®é¢˜** | å­˜åœ¨ | å·²è§£å†³ | å·²è§£å†³ |
| **ç»´æŠ¤éš¾åº¦** | ä¸­ç­‰ | é«˜ | ä½ |
| **æ•…éšœæ’æŸ¥** | å›°éš¾ | å›°éš¾ | å®¹æ˜“ |
| **æ‰©å±•æ€§** | ä¸€èˆ¬ | å¥½ | å¾ˆå¥½ |
| **å¯é æ€§** | ä¸€èˆ¬ | å¥½ | å¾ˆå¥½ |

## ğŸ§ª æµ‹è¯•éªŒè¯

### è¿è¡Œæµ‹è¯•
```bash
# å®Œæ•´æµ‹è¯•
python test_simple_session_architecture.py

# å•ç‹¬æµ‹è¯•SessionKeeper
python -c "from src.session_keeper import SessionKeeper; keeper = SessionKeeper(); print('Test:', keeper.force_refresh())"

# å•ç‹¬æµ‹è¯•SessionClient
python -c "from src.session_client import get_session_info; print(get_session_info())"
```

### é¢„æœŸç»“æœ
```
ğŸ§ª ç®€åŒ–ä¼šè¯æ¶æ„æµ‹è¯•å¼€å§‹
=== æµ‹è¯•SessionKeeper ===
âœ… SessionKeeperåˆå§‹åŒ–æˆåŠŸ
ğŸ”„ æµ‹è¯•å¼ºåˆ¶åˆ·æ–°...
âœ… SessionKeeperåˆ·æ–°æˆåŠŸ

=== æµ‹è¯•SessionClient ===
âœ… SessionClientåˆå§‹åŒ–æˆåŠŸ
âœ… SessionClientè·å–ä¼šè¯æˆåŠŸ

=== æµ‹è¯•æŒ–æ˜æœåŠ¡å¯¼å…¥ ===
âœ… SimulationEngineå¯¼å…¥æˆåŠŸ

ğŸ‰ ç®€åŒ–ä¼šè¯æ¶æ„æµ‹è¯•é€šè¿‡ï¼
```

## ğŸ”„ è¿ç§»æ­¥éª¤

### 1. éƒ¨ç½²æ–°ç»„ä»¶
```bash
# æ–°æ–‡ä»¶å·²åˆ›å»º
# - src/session_keeper.py
# - src/session_client.py
# - start_session_keeper.py
```

### 2. æ›´æ–°ç°æœ‰è„šæœ¬
æŒ–æ˜è„šæœ¬çš„å¯¼å…¥å·²è‡ªåŠ¨æ›´æ–°ï¼š
```python
# ä»
from session_manager import get_session

# æ”¹ä¸º
from session_client import get_session
```

### 3. å¯åŠ¨æ–°æœåŠ¡
```bash
# åœæ­¢åŸæœ‰æŒ–æ˜è„šæœ¬
pkill -f unified_digging_scheduler

# å¯åŠ¨SessionKeeper
python start_session_keeper.py start

# é‡æ–°å¯åŠ¨æŒ–æ˜è„šæœ¬
python src/unified_digging_scheduler.py --stage 1 --n_jobs 1
```

### 4. éªŒè¯æ•ˆæœ
å¯åŠ¨ååº”è¯¥çœ‹åˆ°ï¼š
```
âœ… ä½¿ç”¨ç®€åŒ–ä¼šè¯å®¢æˆ·ç«¯
# è€Œä¸æ˜¯é‡å¤çš„ä¼šè¯åˆ·æ–°æ—¥å¿—
```

## ğŸš¨ æ•…éšœæ’é™¤

### 1. SessionKeeperæ— æ³•å¯åŠ¨
- æ£€æŸ¥ç”¨æˆ·å‡­æ®é…ç½®
- æ£€æŸ¥ç½‘ç»œè¿æ¥
- æŸ¥çœ‹session_keeper.logæ—¥å¿—

### 2. SessionClientè·å–ä¼šè¯å¤±è´¥
- ç¡®ä¿SessionKeeperæ­£åœ¨è¿è¡Œ
- æ£€æŸ¥æ•°æ®åº“è¿æ¥
- éªŒè¯cookiesæ˜¯å¦è¿‡æœŸ

### 3. æŒ–æ˜è„šæœ¬æŠ¥é”™
- ç¡®è®¤å¯¼å…¥è·¯å¾„æ­£ç¡®
- æ£€æŸ¥SessionClientçŠ¶æ€
- æŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯

## ğŸ“ˆ æ€§èƒ½ä¼˜åŠ¿

### èµ„æºä½¿ç”¨
- **CPU**: SessionKeeperå®šæ—¶è¿è¡Œï¼Œå…¶ä»–æ—¶é—´ä¼‘çœ 
- **å†…å­˜**: SessionClientè½»é‡çº§ï¼Œå†…å­˜å ç”¨æå°
- **ç½‘ç»œ**: åªæœ‰SessionKeeperè¿›è¡Œç½‘ç»œè¯·æ±‚ï¼Œé¿å…é‡å¤

### å¯é æ€§
- **å•ç‚¹æ•…éšœ**: SessionKeeperæ•…éšœä¸å½±å“å·²è·å–çš„cookiesä½¿ç”¨
- **è‡ªåŠ¨æ¢å¤**: SessionKeeperè‡ªåŠ¨é‡è¯•å’Œé”™è¯¯å¤„ç†
- **çŠ¶æ€ç›‘æ§**: å®Œæ•´çš„æ—¥å¿—å’ŒçŠ¶æ€ä¿¡æ¯

## ğŸ”§ å…³é”®ä¿®å¤è®°å½•

### ç™»å½•é€»è¾‘ä¿®å¤ (2025-09-06)
**é—®é¢˜**: SessionKeeperå¯åŠ¨æ—¶ç™»å½•å¤±è´¥ (HTTP 400/401é”™è¯¯)

**åŸå› åˆ†æ**:
- âŒ ç”¨æˆ·å‡­æ®è§£æé”™è¯¯ï¼šç›´æ¥è¯»å–è¡Œè€Œéè§£æé”®å€¼å¯¹
- âŒ è®¤è¯æ–¹å¼é”™è¯¯ï¼šä½¿ç”¨JSON POSTè€ŒéBasic Auth
- âŒ çŠ¶æ€ç æœŸæœ›é”™è¯¯ï¼šæœŸæœ›200è€Œé201
- âŒ é”™è¯¯æ£€æŸ¥ä¸ä¸€è‡´ï¼šç¼ºå°‘`INVALID_CREDENTIALS`æ£€æŸ¥

**ä¿®å¤å†…å®¹**:
- âœ… **å‡­æ®è§£æ**: ä½¿ç”¨ä¸`machine_lib_ee.py`ä¸€è‡´çš„è§£ææ–¹å¼
- âœ… **è®¤è¯æ–¹å¼**: ä½¿ç”¨Basic Auth (`session.auth = (username, password)`)
- âœ… **çŠ¶æ€ç **: æœŸæœ›HTTP 201çŠ¶æ€ç 
- âœ… **é”™è¯¯æ£€æŸ¥**: æ£€æŸ¥å“åº”å†…å®¹ä¸­çš„`INVALID_CREDENTIALS`

**ä¿®å¤æ•ˆæœ**:
```
# ä¿®å¤å‰
âŒ ä¼šè¯åˆ·æ–°å¤±è´¥: ç™»å½•å¤±è´¥: ç™»å½•å¤±è´¥ï¼šHTTP 400

# ä¿®å¤å  
âœ… æ–°ä¼šè¯åˆ›å»ºæˆåŠŸ
ğŸ“… ä¼šè¯è¿‡æœŸæ—¶é—´: 2025-09-06 04:56:19
ğŸ§ª æµ‹è¯•è¯·æ±‚çŠ¶æ€ç : 200
âœ… ä¼šè¯éªŒè¯æˆåŠŸ!
```

## ğŸ‰ æ€»ç»“

ç®€åŒ–ä¼šè¯ç®¡ç†æ¶æ„é€šè¿‡**èŒè´£åˆ†ç¦»**å½»åº•è§£å†³äº†å¤šè¿›ç¨‹ä¼šè¯å†²çªé—®é¢˜ï¼š

1. **SessionKeeper**: ä¸“é—¨è´Ÿè´£è®¤è¯ï¼Œç‹¬ç«‹å¯é 
2. **SessionClient**: ä¸“é—¨è´Ÿè´£ä½¿ç”¨ï¼Œè½»é‡ç®€å•
3. **æ•°æ®åº“**: ç»Ÿä¸€å­˜å‚¨ï¼Œé¿å…å†²çª

è¿™ä¸ªæ¶æ„**ç®€å•ã€å¯é ã€æ˜“ç»´æŠ¤**ï¼Œæ˜¯è§£å†³ä¼šè¯ç®¡ç†é—®é¢˜çš„æœ€ä½³æ–¹æ¡ˆã€‚
